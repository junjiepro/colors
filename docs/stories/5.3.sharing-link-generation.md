# Story 5.3: Sharing Link Generation

## Status

- [x] Draft
- [x] Approved
- [ ] In Progress
- [ ] Review
- [ ] Done

## Story

**As a** user of Colors,
**I want to** generate and manage shareable links for my applications,
**so that** I can easily share my work with others while controlling access.

## Acceptance Criteria

1. **Link Generation**
   - Generate unique, secure share links
   - Support different access levels (view, edit, remix)
   - Set link expiration dates
   - Password protection option

2. **Access Control**
   - Manage permissions per link
   - Revoke access at any time
   - View active links and their status
   - Track link usage and analytics

3. **Shared Experience**
   - Customizable landing page
   - Preview before sharing
   - Embed codes for websites
   - Social media sharing options

4. **Security**
   - Prevent unauthorized access
   - Rate limiting for shared links
   - Suspicious activity detection
   - Data protection compliance

## Tasks / Subtasks

- [ ] Implement link generation
  - [ ] Create unique token system (AC: 1.1, 1.2)
  - [ ] Add expiration functionality (AC: 1.3)
  - [ ] Implement password protection (AC: 1.4)
  - [ ] Generate QR codes (AC: 1.1)

- [ ] Build access management
  - [ ] Permission system (AC: 2.1)
  - [ ] Link revocation (AC: 2.2)
  - [ ] Dashboard for management (AC: 2.3)
  - [ ] Usage analytics (AC: 2.4)

- [ ] Create sharing UI
  - [ ] Share dialog component (AC: 3.1, 3.2)
  - [ ] Embed code generator (AC: 3.3)
  - [ ] Social sharing buttons (AC: 3.4)
  - [ ] Copy to clipboard (AC: 3.1)

- [ ] Enhance security
  - [ ] Rate limiting (AC: 4.1, 4.2)
  - [ ] Suspicious activity monitoring (AC: 4.3)
  - [ ] Data protection measures (AC: 4.4)
  - [ ] Audit logging (AC: 2.4, 4.3)

## Dev Notes

### Technical Context

- **Frontend**: Next.js 14 with App Router
- **Backend**: Hono.js with TypeScript
- **Database**: Supabase PostgreSQL
- **Security**: JWT, Rate limiting, CORS
- **Analytics**: Custom tracking with PostHog

### Data Models

```typescript
interface ShareLink {
  id: string;                    // UUID
  token: string;                 // Unique token for the link
  application_id: string;        // Reference to application
  
  // Access Control
  access_level: 'view' | 'edit' | 'remix' | 'admin';
  is_active: boolean;            // Can be deactivated
  expires_at?: Date;             // Optional expiration
  password_hash?: string;        // Optional password protection
  
  // Usage Tracking
  max_uses?: number;             // Optional use limit
  use_count: number;             // Times accessed
  last_used_at?: Date;           // Last access time
  
  // Metadata
  created_by: string;            // User ID
  created_at: Date;
  updated_at: Date;
  
  // Security
  ip_restrictions?: string[];    // Optional IP whitelist
  user_agent_restrictions?: string[]; // Optional UA restrictions
}

interface ShareLinkAnalytics {
  share_link_id: string;
  timestamp: Date;
  
  // Access Details
  ip_address?: string;
  user_agent?: string;
  referrer?: string;
  country?: string;
  
  // Action Details
  action: 'view' | 'interact' | 'remix' | 'download';
  details?: Record<string, any>;
}
```

### API Endpoints

```yaml
# Share Links
POST   /api/shares                     # Create share link
GET    /api/shares                     # List share links
GET    /api/shares/:id                 # Get share link details
PUT    /api/shares/:id                 # Update share link
DELETE /api/shares/:id                 # Delete share link

# Shared Content
GET    /s/:token                       # Access shared content
POST   /api/shares/:token/access       # Authenticate access
GET    /api/shares/:token/analytics    # Get analytics

# Embedded Content
GET    /api/embed/:token               # Get embeddable content
```

### Implementation Strategy

1. **Link Generation**
   - Use cryptographically secure random tokens
   - Implement token hashing for storage
   - Support different access scopes
   - Handle token expiration and revocation

2. **Access Control**
   - JWT-based authentication for shared links
   - Role-based access control
   - IP and user agent validation
   - Rate limiting per token

3. **Security Measures**
   - HTTPS enforcement
   - Secure token generation
   - Input validation
   - Regular security audits

4. **Performance**
   - Cache shared content
   - Optimize database queries
   - Use CDN for static assets
   - Implement efficient analytics collection

## Testing

### Unit Tests

- Token generation and validation
- Permission checks
- Link expiration
- Password protection

### Integration Tests

- Share link creation and access
- Permission enforcement
- Analytics collection
- Rate limiting

### Security Tests

- Token brute force protection
- XSS and CSRF prevention
- Data leakage prevention
- Authentication bypass attempts

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-08-30 | 0.1.0   | Initial draft of Sharing Link Generation | Bob    |
