# Story 3.1: API Key Storage and Encryption

## Status

- [x] Draft
- [ ] Approved
- [ ] In Progress
- [ ] Review
- [ ] Done

## Story

**As a** developer using Colors,
**I want to** securely store and manage my API keys with strong encryption,
**so that** I can safely use them for AI service integrations without exposing sensitive credentials.

## Acceptance Criteria

1. **Secure Key Storage**
   - API keys are encrypted at rest using industry-standard encryption (AES-256)
   - Encryption keys are managed securely using a key management system
   - No plaintext storage of API keys in the database
   - Support for key rotation and versioning

2. **Key Management Interface**
   - Add/Edit/Delete API keys
   - View key metadata (service, creation date, last used)
   - Toggle key activation status
   - Set usage limits and permissions

3. **Security Features**
   - Masked display of API keys (show only first and last 4 characters)
   - Audit logging of key usage
   - Automatic key rotation policies
   - Revocation capability for compromised keys

4. **Integration**
   - Seamless integration with the AI service router
   - Environment variable support for local development
   - API endpoints for programmatic key management

## Tasks / Subtasks

- [ ] Design and implement encryption service
  - [ ] Set up encryption/decryption utilities (AC: 1.1, 1.2, 1.3)
  - [ ] Implement key management system (AC: 1.4)
  - [ ] Add secure key generation (AC: 1.1, 1.2)

- [ ] Build key management interface (AC: 2.1, 2.2, 2.3, 2.4)
  - [ ] Create API key list view
  - [ ] Implement add/edit/delete functionality
  - [ ] Add key usage visualization

- [ ] Implement security features (AC: 3.1, 3.2, 3.3, 3.4)
  - [ ] Add audit logging
  - [ ] Implement key rotation
  - [ ] Create key revocation system

- [ ] Set up integration with AI router (AC: 4.1, 4.2, 4.3)
  - [ ] Create API endpoints for key management
  - [ ] Implement environment variable support
  - [ ] Add documentation for API usage

## Dev Notes

### Technical Context

- **Encryption**: AES-256 with GCM mode
- **Key Management**: AWS KMS or equivalent for production
- **Database**: Supabase PostgreSQL with Row Level Security (RLS)
- **Backend**: Deno with Hono
- **Frontend**: Next.js with TypeScript
- **Security**: JWT for authentication

### Relevant Data Models

```typescript
interface APIKey {
  id: string;
  userId: string;
  service: string;
  name: string;
  encryptedKey: string;
  keyVersion: number;
  isActive: boolean;
  lastUsedAt?: Date;
  usageLimits: {
    rateLimit?: number;
    dailyLimit?: number;
    monthlyLimit?: number;
  };
  metadata: {
    createdBy: string;
    tags?: string[];
    description?: string;
  };
  createdAt: Date;
  updatedAt: Date;
}

interface KeyRotation {
  id: string;
  keyId: string;
  previousKey: string; // Encrypted
  rotatedAt: Date;
  rotatedBy: string;
  reason: 'scheduled' | 'compromised' | 'manual';
}

interface KeyUsageLog {
  id: string;
  keyId: string;
  action: 'create' | 'read' | 'update' | 'delete' | 'use' | 'rotate' | 'revoke';
  performedBy: string;
  performedAt: Date;
  ipAddress?: string;
  userAgent?: string;
  metadata?: Record<string, any>;
}
```

### API Endpoints

- `GET /api/keys` - List API keys
- `POST /api/keys` - Create new API key
- `GET /api/keys/:id` - Get API key details
- `PUT /api/keys/:id` - Update API key
- `DELETE /api/keys/:id` - Delete API key
- `POST /api/keys/:id/rotate` - Rotate API key
- `POST /api/keys/:id/revoke` - Revoke API key
- `GET /api/keys/:id/usage` - Get key usage logs

### Security Considerations

1. **Encryption at Rest**
   - Use AES-256-GCM for encryption
   - Store encryption keys in a secure key management system
   - Implement envelope encryption for additional security

2. **Access Control**
   - Row Level Security (RLS) in Supabase
   - JWT verification for all API endpoints
   - Rate limiting on sensitive endpoints

3. **Audit Logging**
   - Log all key-related operations
   - Include metadata like IP address and user agent
   - Store logs in a tamper-evident manner

## Testing

### Unit Tests

- Encryption/decryption functions
- Key generation and validation
- Permission checks
- Audit logging

### Integration Tests

- API endpoint security
- Key rotation flow
- Usage tracking
- Error handling

### Security Tests

- Penetration testing
- Dependency vulnerability scanning
- Secret scanning in codebase
- OWASP Top 10 compliance

## Change Log

| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-08-29 | 0.1.0   | Initial draft of API Key Storage and Encryption | Bob    |
